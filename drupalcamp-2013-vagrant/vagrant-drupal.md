<div style ="margin:1.5em auto;font-size:1.4em;">
Drupal Development with Vagrant
</div>
<img src="resources/img/name.png" style="position:absolute; bottom:1em;
right:1em;">

--end--

## Outline

* Virtualization
* Automated Infrastructure
* A little bit of Ruby
* Vagrant
* Chef
* Vagrant + Chef for Drupal Development

--end--

## DEV machines
* Works on my machine
* Take hours (if not days) to setup
* Hard to maintain
* Still unpredictable (unknown **state**)
--end---

## Virtualization
--end--

## ![](resources/img/vagrant-200.png)
* Providers: VirtualBox, VMware, EC2, LXC
* Boxes: [www.vagrantbox.es](http://www.vagrantbox.es)
* Networking
* Synced Folders
* Gotchas
----end----
## Vagrant

    #ruby
    Vagrant.configure("2") do |config|
      config.vm.box = "my_box"
      
      # if my_box not found: 'vagrant box add'
      config.vm.box_url = [url/to/download/box]
      
      # configure the box:
      config.vm.provision :shell, :inline => "apt-get install -y apache2"
    end

---end----
## Is it all good now?
* Can we configure all boxes with bash commands?
* What about deployment?
* High risk of change
  * remember Agile?
---end---

## Automated Infrastructure
* Infrastructure as code
  * Deterministic pre-defined state
  * Version Control!
* `dev == prod`
----end----

## Automated Infrastructure
#### what you get:

* One step build and deploy
* Continuous Integration
* Continuous Deployment
  * Flickr: **10** deployments/day
  * Etsy: **25+** deployments/day
* Self-Documenting: defines your infrastructure API

-----end----

## <img src="resources/img/chef.png" width="400px"/> 
* Design Principles:
  * Idempotent 
  * Data-driven
  * Sane defaults
  * Hackability
  * TIMTOWDI

----end---
## Ruby

    #ruby
    def double (x)
      return 2*x
    end
    puts double 12 # => 24

--end----
## Ruby

    #ruby 
    :hello == 'hello'.to_sym

    if File.exists? 'foo'
      puts "found it"
    end
     
    puts "found it" if File.exists? 'foo'

---end---
## Ruby
    #ruby
    ['John','Mary', 'Bob'].each do |guest|
      puts 'Pleased to meet you #{guest}!'
    end
----end---

## Chef
### How does it work?
  * Nodes
  * Attributes
  * Resources
  * Recipes and Cookbooks
    * Run Lists
  * Assets: Files and Templates
---end---
## Chef
#### Attributes
    #json
      {
        "mysql": {
          "server_root_password": "root",
        },
        "apache2":{
          "listen_ports": ["80","8000"]
        }
      }
---end---
## Chef
#### Resources
    
    #ruby
    directory "/path/to/some/directory" do
      owner "user1"
      group "group1"
    end
----end---
## Chef
#### Resources

    #ruby
    execute "some-task" do
      cwd "/path/to/some/directory"
      command "command --with-some options"
      creates "/path/to/some/file"
    end
---end---
## Chef
#### Resources
<div style="font-size:0.6em">

    #ruby
    execute "my-important-file" do
      command "cp -Rf /vagrant/. #{node['drupal-camp']['the-directory']}/"
      creates node['drupal-camp']['the-directory'] + "/foo.txt"
    end

---end---
## Chef
#### Templates
<div style="font-size:0.6em">

    #ruby
    template "/path/to/install/foo.sh" do
      source "foo.sh.erb"
      variables({
        :user => node['apache']['user'], # => www-data
        :group => node['deploy']['dev_group'], # => sysadmin
      })
    end
----end----
## Chef
#### Templates
`my_template.sh.erb`:
    
    #bash
    # script generated by Chef
    #! /bin/bash
    chown <%= @user %>:<%= @group %> /var/www

`/path/to/install/foo.sh`:

    #bash
    # script generated by Chef
    #! /bin/bash
    chown www-data:sysadmin /var/www
-----end---
## Vagrant + Chef

    #ruby
    Vagrant.configure("2") do |config|
      config.vm.box = "my_box"
      
      config.vm.provision :chef_solo do |chef|
        chef.cookbooks_path = ['my_cookbooks']
        # add recipes to Chef run list:
        chef.add_recipe 'drupal-camp::default' 
        # assign Chef attributes:
        chef.json.merge!({
          'drupal-camp' => {
            'important-foo' => '/path/to/foo'
          },
          'mysql' => {
            'root_password' => 'super_secret'
          }
        })   
      end
    end
---end----
## Cookbook Management

* You want to keep your cookbooks as small as possible
* You do not want to recreate existing community cookbooks
* You do not want to manually version control all your dependencies
* You do not even want to manually download all your dependencies
* Cookbook management tools:
  * Berkshelf
  * Librarian-Chef

--end----
## Cookbook Management
Berkshelf

    #ruby
    site :opscode # opscode community cookbooks

    cookbook 'foo', :path => '/path/to/foo'
    cookbook 'bar', :git => 'git://url/to/bar'
    cookbook 'apache2'

----end----
## Let's get some work done!

[github.com/amirkdv/chef-deploy-drupal](http://github.com/amirkdv/chef-deploy-drupal)
[github.com/dergachev/vagrant-drupal](http://github.com/dergachev/vagrant-drupal)
